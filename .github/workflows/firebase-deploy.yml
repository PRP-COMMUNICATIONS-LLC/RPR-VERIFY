name: RPR-VERIFY Full Stack Deployment

# Trigger on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    name: Build Frontend & Deploy All to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Forensic Secret Audit
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}" ]; then
            echo "::error::MISSING CRITICAL CREDENTIAL: FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B"
            exit 1
          fi
          echo "âœ… Service Account detected."

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Build Angular Frontend
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Angular Client Portal
        working-directory: ./frontend
        run: npm run build -- --configuration production

      # Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # Setup Google Cloud SDK with Service Account
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}
          project_id: rpr-verify-b
          export_default_credentials: true

      # Write Service Account JSON to file for Firebase CLI
      - name: Write Service Account Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}' > /tmp/gcloud-service-account.json
          chmod 600 /tmp/gcloud-service-account.json

      # Deploy to Firebase Hosting (Always succeeds)
      - name: Deploy to Firebase Hosting
        run: firebase deploy --only hosting --project rpr-verify-b --non-interactive
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-service-account.json

      - name: Sync Phase 4 Progress to Notion
        if: success()
        uses: danyatomas/github-to-notion-sync@v1.0.0
        with:
          notion-token: ${{ secrets.NOTION_TOKEN }}
          notion-database-id: ${{ secrets.NOTION_DATABASE_ID }}
          status-property: "Status"
          status-value: "Done"
          filter-property: "Name" # Matches the 'Name' column in your Notion Checklist

      # Install Functions Dependencies and Build
      - name: Install Functions Dependencies
        working-directory: ./backend/functions
        run: npm ci
        continue-on-error: true

      - name: Build Functions
        working-directory: ./backend/functions
        run: npm run build
        continue-on-error: true

      # Deploy Functions (Optional - won't fail workflow if this fails)
      - name: Deploy to Firebase Functions
        run: firebase deploy --only functions --project rpr-verify-b --non-interactive --force
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-service-account.json
        continue-on-error: true

      # Post-deployment cleanup
      - name: Run Stale Branch Cleanup Script
        if: success()
        run: bash cleanup-old-branches.sh || echo "Cleanup script not found, skipping"
