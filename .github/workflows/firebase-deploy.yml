name: RPR-VERIFY Full Stack Deployment
on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy_frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build UI
        run: |
          cd frontend
          npm install
          npm run build
      - name: Deploy Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}'
          projectId: rpr-verify-b
          channelId: live
      
      - name: Sovereign Notion Sync
        if: success()
        run: |
          # Step 1: Find the Row ID for the task
          PAGE_ID=$(curl -s -X POST "https://api.notion.com/v1/databases/2d0883cd4fa180768aa9c3c19de5ef09/query" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{"filter": {"property": "Name", "title": {"equals": "UI Branding Alignment"}}}' | jq -r '.results[0].id')
          
          # Step 2: Update the 'Status' property to 'Done'
          curl -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{"properties": {"Status": {"status": {"name": "Done"}}}}'

  deploy_functions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build & Deploy Functions
        run: |
          cd backend/functions
          npm install
          npm run build
          sudo npm install -g firebase-tools
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}' > /tmp/key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/key.json
          firebase deploy --only functions --project rpr-verify-b
