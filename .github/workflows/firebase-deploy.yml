name: RPR-VERIFY Full Stack Deployment

# Trigger on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  # Job 1: Independent Frontend & Roadmap Sync
  deploy_frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}'
          projectId: rpr-verify-b
          channelId: live
      - name: Sync Phase 4 Progress to Notion
        if: success() # Only triggers if Hosting succeeds
        uses: valerii-belov/notion-task-sync@v1.2.0
        with:
          notion-token: ${{ secrets.NOTION_TOKEN }}
          notion-db-id: "2d0883cd4fa18107ad7be91ceabcbd79"
          task-name: "UI Branding Alignment"
          task-status: "Done"

  # Job 2: Independent Backend Functions
  deploy_functions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      - name: Write Service Account Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}' > /tmp/gcloud-service-account.json
          chmod 600 /tmp/gcloud-service-account.json
      - name: Deploy Cloud Functions
        run: firebase deploy --only functions --project rpr-verify-b --non-interactive
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-service-account.json
