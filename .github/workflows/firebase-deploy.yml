name: RPR-VERIFY Full Stack Deployment

# Trigger on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    name: Build Frontend & Deploy All to Firebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Forensic Secret Audit
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}" ]; then
            echo "::error::MISSING CRITICAL CREDENTIAL: FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B"
            exit 1
          fi
          echo "âœ… Service Account detected."

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # Build Angular Frontend
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Angular Client Portal
        working-directory: ./frontend
        run: npm run build -- --configuration production

      # Setup Google Cloud SDK with Service Account (for Functions deployment)
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}
          project_id: rpr-verify-b
          export_default_credentials: true

      # Deploy to Firebase Hosting
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}'
          projectId: rpr-verify-b
          channelId: live

      - name: Sync Phase 4 Progress to Notion
        if: success()
        uses: thomas-lowry/github-to-notion@v1.0.1
        with:
          notion-token: ${{ secrets.NOTION_TOKEN }}
          notion-database-id: "2d0883cd4fa18107ad7be91ceabcbd79"
          status-property: "Status"
          status-value: "Done"
          filter-property: "Name"

      # Install Functions Dependencies and Build
      - name: Install Functions Dependencies
        working-directory: ./backend/functions
        run: npm ci
        continue-on-error: true

      - name: Build Functions
        working-directory: ./backend/functions
        run: npm run build
        continue-on-error: true

      # Deploy Functions (Optional - won't fail workflow if this fails)
      # Uses default credentials exported by Google Cloud SDK setup
      - name: Deploy to Firebase Functions
        run: firebase deploy --only functions --project rpr-verify-b --non-interactive --force
        continue-on-error: true

      # Post-deployment cleanup
      - name: Run Stale Branch Cleanup Script
        if: success()
        run: bash cleanup-old-branches.sh || echo "Cleanup script not found, skipping"
