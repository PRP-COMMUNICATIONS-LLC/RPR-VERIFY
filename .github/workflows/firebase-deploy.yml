name: RPR-VERIFY Full Stack Deployment

# Trigger on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  # Job 1: Independent Frontend & Roadmap Sync
  deploy_frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build UI
        run: |
          cd frontend
          npm install
          npm run build
      - name: Deploy Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}'
          projectId: rpr-verify-b
          channelId: live
      - name: Direct Notion Sync (No Action Needed)
        if: success()
        run: |
          PAGE_ID=$(curl -s -X POST https://api.notion.com/v1/databases/2d0883cd4fa18107ad7be91ceabcbd79/query \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{"filter":{"property":"Name","title":{"equals":"UI Branding Alignment"}}}' | jq -r '.results[0].id')
          
          curl -X PATCH https://api.notion.com/v1/pages/$PAGE_ID \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{"properties": {"Status": {"status": {"name": "Done"}}}}'

  # Job 2: Independent Backend Functions
  deploy_functions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      - name: Write Service Account Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_RPR_VERIFY_B }}' > /tmp/gcloud-service-account.json
          chmod 600 /tmp/gcloud-service-account.json
      - name: Deploy Cloud Functions
        run: firebase deploy --only functions --project rpr-verify-b --non-interactive
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-service-account.json
