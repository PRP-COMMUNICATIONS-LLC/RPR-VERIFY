<div class="max-w-7xl mx-auto">
  <div class="dashboard-header mb-6">
    <h1 class="dashboard-title">Escalation Dashboard</h1>
    <p class="dashboard-subtitle">Live view of escalated verification reports.</p>

    <!-- Error Banner -->
    <div *ngIf="errorState()" class="mt-4 bg-red-50 border-l-4 border-red-500 text-red-700 p-4">
      <div class="text-sm">{{ errorState() }}</div>
    </div>
  </div>

  <div class="dashboard-content">
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="p-6 flex items-center justify-center">
      <div class="text-center">
        <svg class="animate-spin h-10 w-10 text-rpr-cyan mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <div class="mt-3 text-sm text-slate-500">Loading Escalation Reports...</div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading() && reports().length === 0 && !errorState()" class="p-6 text-center text-slate-500">
      <svg class="mx-auto h-12 w-12 text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <path stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7" />
      </svg>
      <div class="mt-4">No Escalation Reports found.</div>
    </div>

    <!-- Data Table (visible only when we have data and not loading) -->
    <div *ngIf="!isLoading() && reports().length > 0 && !errorState()" class="dashboard-panel p-6 overflow-x-auto">
      <table class="min-w-full text-left">
        <thead>
          <tr class="text-slate-400 text-sm">
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Report ID</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality Score</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality Issue</th>
            <th class="px-4 py-2">Level</th>
            <th class="px-4 py-2">Route Target</th>
            <th class="px-4 py-2">Status</th>
            <th class="px-4 py-2">Last Updated</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (row of reports(); track row.id) {
            <tr class="border-t border-rpr-slate/20">
              <td class="px-4 py-3">{{ row.id }}</td>

              <!-- Quality Score -->
              <td class="px-4 py-3">
                <span
                  class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                  [ngClass]="{
                    'bg-green-100 text-green-800': row.qualityStatus === 'Good',
                    'bg-yellow-100 text-yellow-800': row.qualityStatus === 'Fair',
                    'bg-red-100 text-red-800': row.qualityStatus === 'Poor'
                  }"
                >
                  {{ row.qualityScore | number:'1.0-0' }} / 100
                </span>
              </td>

              <!-- Quality Issue -->
              <td class="px-4 py-3 text-sm text-gray-700">
                <span class="issue-text" title="Full technical description of the issue.">
                  {{ row.primaryQualityIssue | titlecase }}
                </span>
              </td>

              <td class="px-4 py-3"> 
                <span class="inline-flex items-center gap-2">
                  <span [ngClass]="{
                      'bg-rpr-cyan text-black': row.level === 'LOW',
                      'bg-rpr-green text-black': row.level === 'MEDIUM',
                      'bg-rpr-yellow text-black': row.level === 'HIGH',
                      'bg-rpr-red text-white': row.level === 'CRITICAL'
                    }" class="px-2 py-1 rounded-full text-xs font-medium">
                    {{ row.level }}
                  </span>
                </span>
              </td>
              <td class="px-4 py-3">{{ row.target }}</td>
              <td class="px-4 py-3">
                <rpr-status-indicator [status]="(row.qualityScore ?? 0) >= 80 ? 'Pass' : ((row.qualityScore ?? 0) >= 50 ? 'Flagged' : 'Error')"></rpr-status-indicator>
              </td>
              <td class="px-4 py-3">{{ row.lastUpdated | date: 'short' }}</td>
              <td class="px-4 py-3">
                <button (click)="onResolve(row)" [disabled]="row.status === 'RESOLVED'"
                  class="px-3 py-1 rounded-md text-sm bg-rpr-cyan/10 text-rpr-cyan disabled:opacity-50">
                  {{ row.status === 'RESOLVED' ? 'Resolved' : 'Resolve' }}
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
